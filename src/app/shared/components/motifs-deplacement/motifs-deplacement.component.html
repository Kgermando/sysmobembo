<div class="layout-wrapper">
  <div class="content-wrapper">
    <!-- Header Section -->
    <div class="header-section">
      <div class="page-header">
        <h1 class="page-title">
          <i class="las la-route"></i>
          Motifs de Déplacement
        </h1>
        <p class="page-description">
          Gestion des motifs et raisons de déplacement des migrants
        </p>
      </div>

      <!-- Statistics Cards -->
      <div class="stats-cards">
        <div class="stat-card">
          <div class="stat-icon">
            <i class="las la-list"></i>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{ stats.total }}</div>
            <div class="stat-label">Total</div>
          </div>
        </div>
        <div class="stat-card success">
          <div class="stat-icon">
            <i class="las la-check-circle"></i>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{ stats.active }}</div>
            <div class="stat-label">Actifs</div>
          </div>
        </div>
        <div class="stat-card warning">
          <div class="stat-icon">
            <i class="las la-times-circle"></i>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{ stats.inactive }}</div>
            <div class="stat-label">Inactifs</div>
          </div>
        </div>
        <div class="stat-card info">
          <div class="stat-icon">
            <i class="las la-tags"></i>
          </div>
          <div class="stat-content">
            <div class="stat-number">{{ categories.length }}</div>
            <div class="stat-label">Catégories</div>
          </div>
        </div>
      </div>
    </div>

    <!-- Search Section -->
    <div class="search-section">
      <form [formGroup]="searchForm" (ngSubmit)="onSearch()" class="search-form">
        <div class="search-row">
          <mat-form-field appearance="outline">
            <mat-label>Recherche</mat-label>
            <input matInput formControlName="search" placeholder="Code, libellé...">
            <mat-icon matSuffix>search</mat-icon>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Catégorie</mat-label>
            <mat-select formControlName="categorie">
              <mat-option value="">Toutes les catégories</mat-option>
              <mat-option *ngFor="let category of categories" [value]="category">
                {{ category | titlecase }}
              </mat-option>
            </mat-select>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Statut</mat-label>
            <mat-select formControlName="actif">
              <mat-option value="">Tous</mat-option>
              <mat-option value="true">Actifs</mat-option>
              <mat-option value="false">Inactifs</mat-option>
            </mat-select>
          </mat-form-field>

          <div class="search-actions">
            <button type="submit" mat-raised-button color="primary">
              <i class="las la-search"></i>
              Rechercher
            </button>
            <button type="button" mat-button (click)="clearSearch()">
              <i class="las la-times"></i>
              Effacer
            </button>
          </div>
        </div>

        <div class="search-row">
          <mat-form-field appearance="outline">
            <mat-label>Priorité minimum</mat-label>
            <input matInput type="number" formControlName="priorite_min" min="1" max="10">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Priorité maximum</mat-label>
            <input matInput type="number" formControlName="priorite_max" min="1" max="10">
          </mat-form-field>
        </div>
      </form>
    </div>

    <!-- Actions Section -->
    <div class="actions-section">
      <button mat-raised-button color="primary" (click)="openCreateModal()">
        <i class="las la-plus"></i>
        Nouveau motif
      </button>
    </div>

    <!-- Table Section -->
    <div class="table-section">
      <mat-table [dataSource]="dataSource" class="data-table">
        <!-- Code Column -->
        <ng-container matColumnDef="code">
          <mat-header-cell *matHeaderCellDef>Code</mat-header-cell>
          <mat-cell *matCellDef="let motif">
            <span class="code-cell">{{ motif.code }}</span>
          </mat-cell>
        </ng-container>

        <!-- French Label Column -->
        <ng-container matColumnDef="libelle_fr">
          <mat-header-cell *matHeaderCellDef>Libellé (FR)</mat-header-cell>
          <mat-cell *matCellDef="let motif">
            <div class="cell-content">
              <span class="primary-text">{{ motif.libelle_fr }}</span>
              <small *ngIf="motif.description" class="text-muted">
                {{ motif.description | slice:0:50 }}{{ motif.description.length > 50 ? '...' : '' }}
              </small>
            </div>
          </mat-cell>
        </ng-container>

        <!-- English Label Column -->
        <ng-container matColumnDef="libelle_en">
          <mat-header-cell *matHeaderCellDef>Libellé (EN)</mat-header-cell>
          <mat-cell *matCellDef="let motif">
            <span class="secondary-text">{{ motif.libelle_en || 'Non défini' }}</span>
          </mat-cell>
        </ng-container>

        <!-- Category Column -->
        <ng-container matColumnDef="categorie">
          <mat-header-cell *matHeaderCellDef>Catégorie</mat-header-cell>
          <mat-cell *matCellDef="let motif">
            <span class="badge" [ngClass]="'badge-' + getCategoryColor(motif.categorie)">
              {{ motif.categorie | titlecase }}
            </span>
          </mat-cell>
        </ng-container>

        <!-- Priority Column -->
        <ng-container matColumnDef="priorite">
          <mat-header-cell *matHeaderCellDef>Priorité</mat-header-cell>
          <mat-cell *matCellDef="let motif">
            <div class="priority-cell">
              <span class="badge" [ngClass]="'badge-' + getPriorityColor(motif.priorite)">
                {{ motif.priorite }}
              </span>
              <small class="priority-label">{{ getPriorityLabel(motif.priorite) }}</small>
            </div>
          </mat-cell>
        </ng-container>

        <!-- Active Status Column -->
        <ng-container matColumnDef="actif">
          <mat-header-cell *matHeaderCellDef>Statut</mat-header-cell>
          <mat-cell *matCellDef="let motif">
            <div class="status-toggle">
              <mat-slide-toggle 
                [checked]="motif.actif"
                (change)="toggleMotifStatus(motif)"
                [color]="motif.actif ? 'primary' : 'warn'">
              </mat-slide-toggle>
              <span class="status-label" [ngClass]="motif.actif ? 'active' : 'inactive'">
                {{ motif.actif ? 'Actif' : 'Inactif' }}
              </span>
            </div>
          </mat-cell>
        </ng-container>

        <!-- Actions Column -->
        <ng-container matColumnDef="actions">
          <mat-header-cell *matHeaderCellDef>Actions</mat-header-cell>
          <mat-cell *matCellDef="let motif">
            <div class="action-buttons">
              <button mat-icon-button 
                      color="primary" 
                      matTooltip="Modifier"
                      (click)="openEditModal(motif)">
                <i class="las la-edit"></i>
              </button>
              
              <button mat-icon-button 
                      color="warn" 
                      matTooltip="Supprimer"
                      (click)="deleteMotif(motif)">
                <i class="las la-trash"></i>
              </button>
            </div>
          </mat-cell>
        </ng-container>

        <mat-header-row *matHeaderRowDef="displayedColumns"></mat-header-row>
        <mat-row *matRowDef="let row; columns: displayedColumns;"></mat-row>
      </mat-table>

      <!-- Pagination -->
      <mat-paginator 
        [length]="totalItems"
        [pageSize]="pageSize"
        [pageSizeOptions]="[15, 25, 50, 100]"
        (page)="onPageChange($event)"
        showFirstLastButtons>
      </mat-paginator>

      <!-- Loading State -->
      <div *ngIf="isLoading" class="loading-container">
        <mat-spinner></mat-spinner>
        <p>Chargement des motifs de déplacement...</p>
      </div>

      <!-- Empty State -->
      <div *ngIf="!isLoading && dataSource.data.length === 0" class="empty-state">
        <i class="las la-route"></i>
        <h3>Aucun motif de déplacement</h3>
        <p>Aucun motif trouvé avec les critères actuels.</p>
      </div>
    </div>
  </div>
</div>

<!-- Motif Form Modal -->
<div class="modal-overlay" *ngIf="isModalOpen" (click)="closeModal()">
  <div class="modal-content" (click)="$event.stopPropagation()">
    <div class="modal-header">
      <h2>
        <i class="las la-route"></i>
        {{ editingMotif ? 'Modifier' : 'Nouveau' }} motif de déplacement
      </h2>
      <button mat-icon-button (click)="closeModal()">
        <i class="las la-times"></i>
      </button>
    </div>

    <form [formGroup]="motifForm" (ngSubmit)="saveMotif()">
      <div class="modal-body">
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Code *</mat-label>
            <input matInput 
                   formControlName="code" 
                   placeholder="Ex: ECON_EMPLOI"
                   [readonly]="!!editingMotif"
                   style="text-transform: uppercase;">
            <mat-hint>Lettres majuscules, chiffres et underscore uniquement</mat-hint>
            <mat-error *ngIf="motifForm.get('code')?.hasError('required')">
              Le code est requis
            </mat-error>
            <mat-error *ngIf="motifForm.get('code')?.hasError('pattern')">
              Format invalide (ex: ECON_EMPLOI)
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Catégorie *</mat-label>
            <mat-select formControlName="categorie" required>
              <mat-option *ngFor="let category of categories" [value]="category">
                {{ category | titlecase }}
              </mat-option>
              <mat-option value="autre">Autre</mat-option>
            </mat-select>
            <mat-error *ngIf="motifForm.get('categorie')?.hasError('required')">
              La catégorie est requise
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Libellé français *</mat-label>
            <input matInput formControlName="libelle_fr" required>
            <mat-error *ngIf="motifForm.get('libelle_fr')?.hasError('required')">
              Le libellé français est requis
            </mat-error>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>Libellé anglais</mat-label>
            <input matInput formControlName="libelle_en">
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>Description</mat-label>
            <textarea matInput 
                      formControlName="description" 
                      rows="3"
                      placeholder="Description détaillée du motif..."></textarea>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>Priorité *</mat-label>
            <mat-select formControlName="priorite" required>
              <mat-option value="1">1 - Très faible</mat-option>
              <mat-option value="2">2 - Faible</mat-option>
              <mat-option value="3">3 - Faible+</mat-option>
              <mat-option value="4">4 - Moyenne-</mat-option>
              <mat-option value="5">5 - Moyenne</mat-option>
              <mat-option value="6">6 - Moyenne+</mat-option>
              <mat-option value="7">7 - Élevée-</mat-option>
              <mat-option value="8">8 - Élevée</mat-option>
              <mat-option value="9">9 - Critique</mat-option>
              <mat-option value="10">10 - Urgente</mat-option>
            </mat-select>
            <mat-error *ngIf="motifForm.get('priorite')?.hasError('required')">
              La priorité est requise
            </mat-error>
          </mat-form-field>

          <div class="status-field">
            <mat-checkbox formControlName="actif">
              Motif actif
            </mat-checkbox>
            <mat-hint>Les motifs inactifs ne sont plus proposés lors de l'enregistrement</mat-hint>
          </div>
        </div>
      </div>

      <div class="modal-footer">
        <button type="button" mat-button (click)="closeModal()">
          Annuler
        </button>
        <button type="submit" 
                mat-raised-button 
                color="primary" 
                [disabled]="!motifForm.valid">
          <i class="las la-save"></i>
          {{ editingMotif ? 'Mettre à jour' : 'Créer' }}
        </button>
      </div>
    </form>
  </div>
</div>
