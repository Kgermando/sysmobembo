<div class="spatial-analysis">
  <!-- Header -->
  <div class="row mb-4">
    <div class="col-12">
      <div class="d-flex justify-content-between align-items-center">
        <div>
          <h4 class="mb-1">
            <i class="la la-map me-2"></i>
            Spatial Analysis Dashboard
          </h4>
          <p class="text-muted mb-0">Geographic distribution and spatial patterns analysis</p>
        </div>
        <div class="d-flex gap-2">
          <button class="btn btn-outline-primary btn-sm" (click)="refreshData()" [disabled]="loading">
            <i class="la la-refresh me-1"></i>
            Refresh
          </button>
          <div class="dropdown">
            <button class="btn btn-outline-secondary btn-sm dropdown-toggle" type="button" 
                    data-bs-toggle="dropdown">
              <i class="la la-download me-1"></i>
              Export
            </button>
            <ul class="dropdown-menu">
              <li><a class="dropdown-item" href="#" (click)="exportDensityData()">
                <i class="la la-file-csv me-2"></i>Density Data
              </a></li>
              <li><a class="dropdown-item" href="#" (click)="exportCorridorData()">
                <i class="la la-file-csv me-2"></i>Corridor Data
              </a></li>
              <li><a class="dropdown-item" href="#" (click)="exportProximityData()">
                <i class="la la-file-csv me-2"></i>Proximity Data
              </a></li>
            </ul>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Loading State -->
  <div *ngIf="loading" class="text-center py-5">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Loading...</span>
    </div>
    <p class="mt-3 text-muted">Loading spatial analysis data...</p>
  </div>

  <!-- Main Content -->
  <div *ngIf="!loading">
    <!-- Key Metrics -->
    <div class="row mb-4">
      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="metric-icon bg-primary">
                <i class="la la-layer-group"></i>
              </div>
              <div class="ms-3">
                <h6 class="metric-label">Total Clusters</h6>
                <div class="metric-value">{{ spatialMetrics.totalClusters || 0 }}</div>
                <small class="text-success">
                  <i class="la la-arrow-up"></i>
                  +{{ spatialMetrics.clusterGrowth || 0 }}% vs last month
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="metric-icon bg-success">
                <i class="la la-expand-arrows-alt"></i>
              </div>
              <div class="ms-3">
                <h6 class="metric-label">Coverage Area</h6>
                <div class="metric-value">{{ spatialMetrics.coverageArea || 0 | number:'1.1-1' }}</div>
                <small class="text-muted">km² analyzed</small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="metric-icon bg-warning">
                <i class="la la-route"></i>
              </div>
              <div class="ms-3">
                <h6 class="metric-label">Active Corridors</h6>
                <div class="metric-value">{{ spatialMetrics.activeCoorridors || 0 }}</div>
                <small class="text-info">
                  <i class="la la-info-circle"></i>
                  {{ spatialMetrics.corridorEfficiency || 0 }}% efficiency
                </small>
              </div>
            </div>
          </div>
        </div>
      </div>

      <div class="col-lg-3 col-md-6 mb-3">
        <div class="card metric-card">
          <div class="card-body">
            <div class="d-flex align-items-center">
              <div class="metric-icon bg-info">
                <i class="la la-compress-arrows-alt"></i>
              </div>
              <div class="ms-3">
                <h6 class="metric-label">Avg Distance</h6>
                <div class="metric-value">{{ spatialMetrics.avgDistance || 0 | number:'1.1-1' }}</div>
                <small class="text-muted">km between points</small>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Analysis Tabs -->
    <div class="row">
      <div class="col-12">
        <div class="card">
          <div class="card-header">
            <ul class="nav nav-tabs analysis-tabs" role="tablist">
              <li class="nav-item" role="presentation">
                <button class="nav-link" 
                        [class.active]="activeTab === 'density'"
                        (click)="onTabChange('density')"
                        type="button">
                  <i class="la la-th"></i>
                  <span>Density Analysis</span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link"
                        [class.active]="activeTab === 'corridors'"
                        (click)="onTabChange('corridors')"
                        type="button">
                  <i class="la la-route"></i>
                  <span>Migration Corridors</span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link"
                        [class.active]="activeTab === 'proximity'"
                        (click)="onTabChange('proximity')"
                        type="button">
                  <i class="la la-compress-arrows-alt"></i>
                  <span>Proximity Analysis</span>
                </button>
              </li>
              <li class="nav-item" role="presentation">
                <button class="nav-link"
                        [class.active]="activeTab === 'clusters'"
                        (click)="onTabChange('clusters')"
                        type="button">
                  <i class="la la-layer-group"></i>
                  <span>Cluster Analysis</span>
                </button>
              </li>
            </ul>
          </div>

          <div class="card-body p-0">
            <!-- Density Analysis Tab -->
            <div *ngIf="activeTab === 'density'" class="tab-content p-4">
              <div class="row">
                <div class="col-lg-8">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">
                        <i class="la la-chart-area me-2"></i>
                        Population Density Distribution
                      </h6>
                    </div>
                    <div class="card-body">
                      <apx-chart [series]="densityChartOptions.series"
                                [chart]="densityChartOptions.chart"
                                [xaxis]="densityChartOptions.xaxis"
                                [yaxis]="densityChartOptions.yaxis"
                                [stroke]="densityChartOptions.stroke"
                                [fill]="densityChartOptions.fill"
                                [dataLabels]="densityChartOptions.dataLabels"
                                [grid]="densityChartOptions.grid"
                                [tooltip]="densityChartOptions.tooltip">
                      </apx-chart>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">
                        <i class="la la-fire me-2"></i>
                        Spatial Heatmap
                      </h6>
                    </div>
                    <div class="card-body">
                      <apx-chart [series]="heatmapChartOptions.series"
                                [chart]="heatmapChartOptions.chart"
                                [dataLabels]="heatmapChartOptions.dataLabels"
                                [plotOptions]="heatmapChartOptions.plotOptions"
                                [xaxis]="heatmapChartOptions.xaxis"
                                [colors]="heatmapChartOptions.colors">
                      </apx-chart>
                    </div>
                  </div>

                  <div class="card mt-3">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Density Zones</h6>
                    </div>
                    <div class="card-body p-0">
                      <div class="density-zones-list">
                        <div *ngFor="let zone of densityData" 
                             class="density-zone-item"
                             [class]="'density-' + (zone.density < 50 ? 'low' : zone.density < 100 ? 'medium' : 'high')">
                          <div class="zone-info">
                            <h6>{{ zone.region }}</h6>
                            <small class="text-muted">{{ zone.area }} km²</small>
                          </div>
                          <div class="density-indicator">
                            <div class="density-value" [style.color]="getDensityColor(zone.density)">
                              {{ formatDensity(zone.density) }}
                            </div>
                            <div class="density-bar">
                              <div class="density-fill" 
                                   [style.width.%]="(zone.density / 300) * 100"
                                   [style.background-color]="getDensityColor(zone.density)">
                              </div>
                            </div>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Migration Corridors Tab -->
            <div *ngIf="activeTab === 'corridors'" class="tab-content p-4">
              <div class="row">
                <div class="col-lg-8">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">
                        <i class="la la-chart-line me-2"></i>
                        Migration Flow Timeline
                      </h6>
                    </div>
                    <div class="card-body">
                      <apx-chart [series]="corridorChartOptions.series"
                                [chart]="corridorChartOptions.chart"
                                [xaxis]="corridorChartOptions.xaxis"
                                [yaxis]="corridorChartOptions.yaxis"
                                [stroke]="corridorChartOptions.stroke"
                                [dataLabels]="corridorChartOptions.dataLabels"
                                [legend]="corridorChartOptions.legend"
                                [colors]="corridorChartOptions.colors"
                                [tooltip]="corridorChartOptions.tooltip">
                      </apx-chart>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Active Corridors</h6>
                    </div>
                    <div class="card-body p-0">
                      <div class="corridors-list">
                        <div *ngFor="let corridor of corridorData" class="corridor-item">
                          <div class="corridor-path">
                            <div class="origin">{{ corridor.origin }}</div>
                            <i class="la la-arrow-right"></i>
                            <div class="destination">{{ corridor.destination }}</div>
                          </div>
                          <div class="corridor-stats">
                            <div class="total-migrants">
                              <strong>{{ corridor.totalMigrants | number }}</strong>
                              <small class="text-muted d-block">Total Migrants</small>
                            </div>
                            <div class="intensity-badge"
                                 [class]="'intensity-' + getCorridorIntensityClass(corridor.intensity)">
                              {{ getCorridorIntensity(corridor.intensity) }}
                            </div>
                          </div>
                          <div class="corridor-metrics">
                            <small class="text-muted">
                              Distance: {{ formatDistance(corridor.distance) }} | 
                              Peak: {{ corridor.peakMonth }}
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Proximity Analysis Tab -->
            <div *ngIf="activeTab === 'proximity'" class="tab-content p-4">
              <div class="row">
                <div class="col-lg-8">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">
                        <i class="la la-chart-bar me-2"></i>
                        Average Distance Analysis
                      </h6>
                    </div>
                    <div class="card-body">
                      <apx-chart [series]="proximityChartOptions.series"
                                [chart]="proximityChartOptions.chart"
                                [plotOptions]="proximityChartOptions.plotOptions"
                                [dataLabels]="proximityChartOptions.dataLabels"
                                [stroke]="proximityChartOptions.stroke"
                                [xaxis]="proximityChartOptions.xaxis"
                                [yaxis]="proximityChartOptions.yaxis"
                                [fill]="proximityChartOptions.fill"
                                [tooltip]="proximityChartOptions.tooltip">
                      </apx-chart>
                    </div>
                  </div>
                </div>
                <div class="col-lg-4">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Proximity Centers</h6>
                    </div>
                    <div class="card-body p-0">
                      <div class="proximity-centers-list">
                        <div *ngFor="let center of proximityData" class="proximity-center-item">
                          <div class="center-info">
                            <h6>{{ center.center }}</h6>
                            <small class="text-muted">Analysis Center</small>
                          </div>
                          <div class="distance-metrics">
                            <div class="avg-distance">
                              <strong>{{ formatDistance(center.avgDistance) }}</strong>
                              <small class="text-muted d-block">Avg Distance</small>
                            </div>
                            <div class="point-count">
                              <strong>{{ center.pointCount | number }}</strong>
                              <small class="text-muted d-block">Data Points</small>
                            </div>
                          </div>
                          <div class="distance-range">
                            <small class="text-muted">
                              Range: {{ formatDistance(center.minDistance) }} - {{ formatDistance(center.maxDistance) }}
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>

            <!-- Cluster Analysis Tab -->
            <div *ngIf="activeTab === 'clusters'" class="tab-content p-4">
              <div class="row">
                <div class="col-lg-6">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">
                        <i class="la la-chart-pie me-2"></i>
                        Cluster Distribution
                      </h6>
                    </div>
                    <div class="card-body">
                      <apx-chart [series]="clusterChartOptions.series"
                                [chart]="clusterChartOptions.chart"
                                [labels]="clusterChartOptions.labels"
                                [colors]="clusterChartOptions.colors"
                                [legend]="clusterChartOptions.legend"
                                [plotOptions]="clusterChartOptions.plotOptions"
                                [tooltip]="clusterChartOptions.tooltip">
                      </apx-chart>
                    </div>
                  </div>
                </div>
                <div class="col-lg-6">
                  <div class="card">
                    <div class="card-header">
                      <h6 class="card-title mb-0">Cluster Details</h6>
                    </div>
                    <div class="card-body p-0">
                      <div class="clusters-list">
                        <div *ngFor="let cluster of densityClusters" 
                             class="cluster-item"
                             [class]="'cluster-' + getClusterSizeClass(cluster.size)">
                          <div class="cluster-info">
                            <h6>{{ cluster.label }}</h6>
                            <small class="text-muted">{{ cluster.region }}</small>
                          </div>
                          <div class="cluster-metrics">
                            <div class="cluster-size">
                              <strong>{{ cluster.size | number }}</strong>
                              <small class="text-muted d-block">Population</small>
                            </div>
                            <div class="cluster-density">
                              <strong>{{ formatDensity(cluster.density) }}</strong>
                              <small class="text-muted d-block">Density</small>
                            </div>
                          </div>
                          <div class="cluster-coordinates">
                            <small class="text-muted">
                              {{ cluster.center.lat.toFixed(4) }}, {{ cluster.center.lng.toFixed(4) }}
                            </small>
                          </div>
                        </div>
                      </div>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>
